<!DOCTYPE html>
<html lang="es" dir="ltr">

<head>
  <meta name="generator" content="Hugo 0.82.0" />
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Api para un display de siete segmentos #  Escribamos una biblioteca/api sencilla que nos permita configurar un número en un display de 7 segmentos, el circuito es el siguiente,
Conexión Arduino-Display #  Contamos con un display de cátodo común por lo tanto cada segmento se enciende con un voltaje alto en el pin correspondiente, es decir para encender el segmento &ldquo;A&rdquo; debemos configurar el pin digital D2 en alto.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="Api Display Siete Segmentos" />
<meta property="og:description" content="Api para un display de siete segmentos #  Escribamos una biblioteca/api sencilla que nos permita configurar un número en un display de 7 segmentos, el circuito es el siguiente,
Conexión Arduino-Display #  Contamos con un display de cátodo común por lo tanto cada segmento se enciende con un voltaje alto en el pin correspondiente, es decir para encender el segmento &ldquo;A&rdquo; debemos configurar el pin digital D2 en alto." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://delightful-sea-0ab343910.azurestaticapps.net/docs/perifericos/gpio/biblioteca7/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2019-06-19T04:37:56&#43;00:00" />
<meta property="article:modified_time" content="2019-06-19T04:37:56&#43;00:00" />

<title>Api Display Siete Segmentos | Blog sobre sistemas embebidos</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.2bc2364a4a4b31f0ec1debecf0a8f90a840821f143dfe1ac6a0f7cbcbdcf64ac.css" integrity="sha256-K8I2SkpLMfDsHevs8Kj5CoQIIfFD3&#43;Gsag98vL3PZKw=">
<script defer src="/es.search.min.b3511896043460e7f682c3be79cc02f42aa445b8ca5a9832cf618ac86bb76e53.js" integrity="sha256-s1EYlgQ0YOf2gsO&#43;ecwC9CqkRbjKWpgyz2GKyGu3blM="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a href="/"><span>Blog sobre sistemas embebidos</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Buscar" aria-label="Buscar" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-6f6f484549ce2d8602f7989616e2f29f" class="toggle"  />
    <label for="section-6f6f484549ce2d8602f7989616e2f29f" class="flex justify-between">
      <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/workstation/" class="">Estación de trabajo.</a>
      <span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/workstation/arduino-basico-iii/" class="">Arduino Básico III</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/workstation/arduino-basico-ii-hola-mundo/" class="">Arduino Básico II.- Hola Mundo</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/workstation/arduino-basico-i/" class="">Arduino Básico I.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/workstation/estacion-de-trabajo-iv/" class="">Estación de trabajo IV</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/workstation/estacion-de-trabajo-iii/" class="">Estación de trabajo III</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/workstation/estacion-de-trabajo-ii/" class="">Estación de trabajo II</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/workstation/estacion-de-trabajo-i/" class="">Estación de trabajo I</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c5a8f28f5516b1587793df786fc2352d" class="toggle"  />
    <label for="section-c5a8f28f5516b1587793df786fc2352d" class="flex justify-between">
      <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/" class="">Programación Avr en C.</a>
      <span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/programando-avr-en-c-arreglos/" class="">Programando Avr en C. Arreglos.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/programando-avr-en-c-apuntadores-punteros-pointers-ii-apuntadores-dobles/" class="">Programando Avr en C.- Apuntadores, punteros, pointers III. Apuntadores Dobles.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/programando-avr-en-c-apuntadores-punteros-pointers-ii-apuntadores-a-funciones/" class="">Programando Avr en C.- Apuntadores, punteros, pointers II. Apuntadores a funciones.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/programando-avr-en-c-apuntadores-punteros-pointers/" class="">Programando Avr en C.- Apuntadores, punteros, pointers I.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/programando-avr-en-c-el-flujo-del-programa-if-else-if-else/" class="">Programando Avr en C.- El flujo del programa, if, else, if else.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/programando-avr-en-c-constantes/" class="">Programando Avr en C.- Constantes</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/programando-avr-en-c-tipo-de-dato-booleano-operadores-booleanos-y-de-comparacion/" class="">Programando Avr en C.- Tipo de dato Booleano, operadores booleanos y de comparación.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/programando-avr-en-c-funciones/" class="">Programando Avr en C.- Funciones</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/programando-avr-en-c-variables-y-tipos-caracteres/" class="">Programando Avr en C.- Variables y tipos, caracteres.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/programando-avr-en-c-variables-y-tipos-enteros/" class="">Programando Avr en C.- Variables y tipos.- Enteros.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/avr/programando-avr-en-c-hola-mundo/" class="">Programando Avr en C.- Hola mundo</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Perifericos</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-32e0e2a16668b9d33b9df31ea5765d8c" class="toggle" checked />
    <label for="section-32e0e2a16668b9d33b9df31ea5765d8c" class="flex justify-between">
      <a  class="">GPIO</a>
      <span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/perifericos/gpio/perifericos-atmega328p-puertos-de-entrada-salida-de-proposito-general-gpio-vii-display-siete-segmentos/" class="">Display Siete Segmentos VI.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/perifericos/gpio/perifericos-atmega328p-puertos-de-entrada-salida-de-proposito-general-gpio-vi-display-siete-segmentos/" class="">Display Siete Segmentos V.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/perifericos/gpio/perifericos-atmega328p-puertos-de-entrada-salida-de-proposito-general-gpio-v-display-siete-segmentos/" class="">Display Siete Segmentos IV.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/perifericos/gpio/perifericos-atmega328p-puertos-de-entrada-salida-de-proposito-general-gpio-iv-display-siete-segmentos/" class="">Display Siete Segmentos III.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/perifericos/gpio/perifericos-atmega328p-puertos-de-entrada-salida-de-proposito-general-gpio-iii-display-siete-segmentos/" class="">Display Siete Segmentos II.</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/perifericos/gpio/biblioteca7/" class=" active">Api Display Siete Segmentos</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://delightful-sea-0ab343910.azurestaticapps.net/docs/perifericos/gpio/perifericos-atmega328p-puertos-de-entrada-salida-de-proposito-general-gpio/" class="">Periféricos atmega328p.- Puertos de entrada/salida de propósito general (GPIO)</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var a=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Api Display Siete Segmentos</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#conexión-arduino-display">Conexión Arduino-Display</a></li>
    <li><a href="#biblioteca">Biblioteca</a></li>
    <li><a href="#crear-la-biblioteca">Crear la biblioteca</a></li>
    <li><a href="#implementando-la-biblioteca">Implementando la biblioteca</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="api-para-un-display-de-siete-segmentos">
  Api para un display de siete segmentos
  <a class="anchor" href="#api-para-un-display-de-siete-segmentos">#</a>
</h1>
<p>Escribamos una biblioteca/api sencilla que nos permita configurar un número en
un display de 7 segmentos, el circuito es el siguiente,</p>
<p><img src="/img/circuito7seg.png" alt="Circuito" /></p>
<h2 id="conexión-arduino-display">
  Conexión Arduino-Display
  <a class="anchor" href="#conexi%c3%b3n-arduino-display">#</a>
</h2>
<p>Contamos con un display de cátodo común por lo tanto cada segmento se enciende
con un voltaje alto en el pin correspondiente, es decir para encender el segmento
&ldquo;A&rdquo; debemos configurar el pin digital <strong>D2</strong> en alto. Evitamos la conexión en
los pines D0 y D1, debido a que estos están conectados al convertidor serial-usb,
y pueden provocar problemas para subir el código a la tarjeta.</p>
<p>Como primer paso debemos incluir la biblioteca &ldquo;avr/io.h&rdquo;, para tener acceso a
los puertos de GPIOx de entrada/salida, cuyos registros asociados son DDRx,
PORTx, PINx.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;avr/io.h&gt;</span><span style="color:#75715e">
</span></code></pre></div><p>Ahora declaramos la función principal, recordemos que la función principal es
llamada automáticamente cuando el programa es ejecutado,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
{
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Dentro de las llaves del main configuramos los pines adecuados como salidas,
para hacerlo requerimos
saber a que pines del microcontrolador corresponden los pines del Arduino,</p>
<p><img src="http://www.chicoree.fr/w/images/9/95/ATmega328P_vs_Arduino_pin_mapping.png" alt="Correspondencia de pines" />
fuente:(<a href="http://www.chicoree.fr/w/Arduino_sur_ATmega328P">http://www.chicoree.fr/w/Arduino_sur_ATmega328P</a>)</p>
<p>En la anterior imagen observamos la correspondencia entre los pines del Arduino
y los del microcontrolador, por ejemplo el pin digital D2 es en realidad el pin
PD2 del atmega328p, por ejemplo el pin digital D8 es en realidad el pin PB0 del
atmega328p. Configuramos el registro DDRB y DDRD como salidas,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">DDRB <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PB0);
DDRD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD2)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD3)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD4)<span style="color:#f92672">|</span>
        (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD5)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD6)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD7);
</code></pre></div><p>Ahora solo encendemos los leds, poniendo en alto los pines requeridos, por
ejemplo para el número cinco, encendemos los segmentos a,c,d,f,g.</p>
<p><img src="/img/7segdia5.png" alt="Cinco" /></p>
<p>Para ello escribimos a los puertos PORTB y PORTD los pines indicados</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">PORTB <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PB0);
PORTD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD2)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD4)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD5)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD7);
</code></pre></div><p>El código completo luce como el siguiente,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;avr/io.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
{
       DDRB <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PB0);
       DDRD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD2)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD3)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD4)<span style="color:#f92672">|</span>
               (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD5)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD6)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD7);
       PORTB <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PB0);
       PORTD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD2)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD4)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD5)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD7);
       <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Compilamos y subimos.</p>
<p><img src="/img/7seg5.png" alt="Ejecutando" /></p>
<p>El &ldquo;estilo&rdquo; en que hemos escrito nuestro programa es coloquialmente llamado
hardcoding, debido a que nosotros especificamos tanto los valores como el flujo,
usualmente lo que queremos es que el programa calcule los valores y elija el
flujo, imaginemos que ahora requerimos una secuencia de números en serie,
comenzado con 1 y terminando en 9 y repetir esta secuencia 1000 veces, seria un
poco tedioso cambiar uno por uno los estados de los segmentos, para evitar este
trabajo nos apoyaremos en funciones y sentencias de flujo.</p>
<h2 id="biblioteca">
  Biblioteca
  <a class="anchor" href="#biblioteca">#</a>
</h2>
<p>Nuestro anterior programa sirve para dos cosas, para nada y para la basura, no hay
ninguna diferencia con respecto a conectar los pines del display directamente a
Vcc, requerimos funcionalidad, que el microcontrolador haga lo adecuado para mostrar
cualquier número indicado, con una interfaz del tipo</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">display7_showNumber(<span style="color:#ae81ff">3</span>); <span style="color:#75715e">//Muestra el número 3 en el display
</span></code></pre></div><p>de esta forma podemos realizar una secuencia de números</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
{
  <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
    display7_showNumber(<span style="color:#ae81ff">0</span>);
    <span style="color:#75715e">//delay
</span><span style="color:#75715e"></span>    display7_showNumber(<span style="color:#ae81ff">1</span>);
    <span style="color:#75715e">//delay
</span><span style="color:#75715e"></span>    .
    .
    .
    display7_showNumber(<span style="color:#ae81ff">9</span>);
    <span style="color:#75715e">//delay     
</span><span style="color:#75715e"></span>  }
}
</code></pre></div><p>El display mostrara los números del 0 al 9 en orden ascendente, nuestro objetivo
entonces es definir la función <code>display7_showNumber(short const number)</code>.</p>
<p>Aunque en este problema sencillo podemos programar la solución de forma
monolítica(un solo fragmento de código), es de utilidad desarrollarlo en forma
modular, como en la siguiente figura</p>
<p><img src="/img/7segdep.png" alt="" /></p>
<p>De tal forma que podemos utilizarla dentro de nuestra aplicación con un simple
include, pensar en forma modular tiene grandes ventajas y conforme crece el
proyecto se vuelve la única forma sostenible de escribir código, la primer gran
ventaja es la posibilidad de reutilizar código, seria absurdo escribir un
controlador de 7 segmentos en cada proyecto nuevo, la segunda ventaja es la
capacidad de extender el código ya escrito, la tercer gran ventaja es que el
código es más &ldquo;mantenible&rdquo;, entre muchas otras que se irán comentando.</p>
<p>Para nuestro propósito un módulo es un ente de software que está débilmente acoplado,
autocontenido y es altamente cohesivo, dicho de otra forma, la función main no
tiene conocimiento de las variables y funciones del módulo, salvo por un
conjunto de funciones comúnmente llamadas interfaz. Una bonita interfaz para
nuestro modulo puede ser</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_init</span>(<span style="color:#66d9ef">void</span>);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> number);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>);
</code></pre></div><p>Elegir buenos nombres es una parte fundamental para que nuestro código sea de
alta calidad, estoy seguro que al leer las funciones anteriores de inmediato
formaste una idea de lo que hacen y a que pertenecen. Sin pensarlo hemos llegado
a uno de los grandes dogmas de la programación y de la resolución de problemas
en general,</p>
<p><em>Divide el problema en problemas más pequeños</em></p>
<p>Ni tardos ni perezosos modificamos nuestro programa y agregamos el módulo,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;avr/io.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_init</span>(<span style="color:#66d9ef">void</span>);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> number);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>);

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
{
       DDRB <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PB0);
       DDRD <span style="color:#f92672">|=</span>  (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD2)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD3)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD4)<span style="color:#f92672">|</span>
                (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD5)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD6)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD7);
       PORTB <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PB0);
       PORTD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD2)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD4)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD5)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD7);
       <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_init</span>(<span style="color:#66d9ef">void</span>)
{
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> number)
{
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>)
{
}
</code></pre></div><p>Este código compila sin problemas pero no hace el trabajo requerido, al
principio agregamos los prototipos del módulo, pero aun no los llamamos en la
función main, tampoco hemos implementado dichas funciones. Antes de definir la
interfaz, anteriormente indique que la función main no tiene conocimiento de las
funciones y variables de nuestro módulo, si escribimos el código en el mismo
fichero, el usuario de la función main tendrá a la vista todas las funciones y
variables y probablemente tenga la tentación de usarlas, una buena idea para
evitar que esto suceda es utilizar un par de archivos extra exclusivos para
nuestro módulo.</p>
<h2 id="crear-la-biblioteca">
  Crear la biblioteca
  <a class="anchor" href="#crear-la-biblioteca">#</a>
</h2>
<p>No se si ya lo había mencionado pero odio el entorno de desarrollo de Arduino,
en esta ocasión por la forma tan pobre de manejar ficheros. Continuando, vamos
a mover nuestro módulo en un par de archivos, creamos dos ficheros cuyo nombre
deje en claro que hay escrito en él, un buen nombre es display7,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">$touch display7.c
$touch display7.h
</code></pre></div><p>Ahora en nuestro entorno de desarrollo incluimos los dos ficheros, para ello
vamos al menú <strong>Programa-&gt;Añadir fichero</strong> y añadimos ambos ficheros, ambos
aparecerán en nuestro entorno de desarrollo y podrán ser editados desde el mismo,
movemos desde el fichero principal el módulo hacia los nuevos ficheros,
los prototipos van en él .h y las definiciones al .c, de esta manera tenemos
los tres ficheros siguientes</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">//proyecto.ino
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;avr/io.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
{
       DDRB <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PB0);
       DDRD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD2)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD3)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD4)<span style="color:#f92672">|</span>
               (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD5)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD6)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD7);
       PORTB <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PB0);
       PORTD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD2)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD4)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD5)<span style="color:#f92672">|</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>PD7);
       <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">//display7.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_init</span>(<span style="color:#66d9ef">void</span>);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> number);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">//display7.c
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_init</span>(<span style="color:#66d9ef">void</span>)
{
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> number)
{
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>)
{
}
</code></pre></div><p>Nuevamente compilamos el programa y no nos dará ningún error, salvo el pequeño
detalle de que no hace nada. Para poder acceder a la interfaz del módulo, es
necesario incluirla en nuestro fichero principal, basta con agregar la directiva
<code>#include&quot;display7.h&quot;</code> antes de la función main, de esta forma el módulo puede ser
desarrollado de forma independiente y paralela al programa principal,
modifiquemos nuestro .ino para usar la interfaz</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;utils/delay.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span><span style="color:#75715e">&#34;display7.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
{
	display7_init();
	<span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
		display7_showNumber(<span style="color:#ae81ff">0</span>);
		_delay_ms(<span style="color:#ae81ff">1000</span>);
		display7_showNumber(<span style="color:#ae81ff">1</span>);
		_delay_ms(<span style="color:#ae81ff">1000</span>);
	}
}
</code></pre></div><p>Pienso que el código se ve definitivamente más limpio y muestra claramente que
se está haciendo, sin embargo si tratamos de compilar nos dará un error,
similar a este</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">undefined reference to <span style="color:#e6db74">`</span>display7_init<span style="color:#f92672">()</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</code></pre></div><p>En pocas palabras el compilador (en realidad el linker) no encuentra las
definiciones del módulo, las definiciones están en el fichero .c, como
mencionamos en entradas anteriores, el entorno Arduino en realidad compila
ficheros C++, pero como somos tercos y queremos programar en c debemos indicarle
al compilador que nuestro ficheros no son C++, esto es muy sencillo, basta con
añadir</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> {
</code></pre></div><p>En el fichero .h donde están los prototipos y cerrar después del ultimo
prototipo con un</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">}
</code></pre></div><p>El archivo .h queda</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> {
<span style="color:#66d9ef">void</span> display7_init(<span style="color:#66d9ef">void</span>);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> number);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>);
}
</code></pre></div><p>Compilamos y esta vez no obtendremos ningún error. De esta forma el compilador
hará lo adecuado para poder usar el módulo, la solución sirve para nuestros
propósitos, sin embargo en el futuro, desarrollaremos nuestros programas con un
compilador de &ldquo;c&rdquo;, el compilador no entenderá la línea extern &ldquo;C&rdquo; y nos dará un
error, ¿cómo hacemos que el módulo funcione con el compilador de C y también con
el de c++?, nuevamente la solución es sencilla, cuando usamos un compilador de
C++, este pasa una definición, explicitamente</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">#define __cplusplus
</span></code></pre></div><p>lo anterior no sucede cuando compilamos con un compilador de C, aprovechando
esta definición podemos usar la directiva</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">#ifdef ALGO
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//si ALGO fue definido, coloca estas lineas
</span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></code></pre></div><p>Modificamos el fichero .h y escribimos</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">//display7.h
</span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef __cplusplus
</span><span style="color:#75715e"></span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> {
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> display7_init(<span style="color:#66d9ef">void</span>);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> number);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>);

<span style="color:#75715e">#ifdef __cplusplus
</span><span style="color:#75715e"></span>}
<span style="color:#75715e">#endif
</span></code></pre></div><p>El fichero está casi listo, funciona con ambos compiladores, sin embargo tiene
un gran problema, ¿qué pasa si por error incluimos más de una vez nuestras
interfaz?, la respuesta es que nos indicara un error de doble declaración,
nuevamente nos apoyamos en la directiva #define, de la forma</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">#ifndef MODULO
</span><span style="color:#75715e">#define MODULO
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//Aquí las definiciones
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#endif
</span></code></pre></div><p>Significa, si no esta definido, define y coloca la interfaz, de lo contrario si
ya esta definido no hagas nada, nuestra implementación queda así</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">//display7.h
</span><span style="color:#75715e"></span><span style="color:#75715e">#ifndef DISPLAY7_H
</span><span style="color:#75715e">#define DISPLAY7_H
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#ifdef __cplusplus
</span><span style="color:#75715e"></span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> {
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> display7_init(<span style="color:#66d9ef">void</span>);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> number);
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>);

<span style="color:#75715e">#ifdef __cplusplus
</span><span style="color:#75715e"></span>}
<span style="color:#75715e">#endif
</span><span style="color:#75715e">#endif</span><span style="color:#75715e">//DISPLAY7_H
</span></code></pre></div><p>El fichero principal queda así</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C++" data-lang="C++"><span style="color:#75715e">//proyecto.ino
</span><span style="color:#75715e">//Necesario para _delay_ms(), frecuencia de nuestro arduino
</span><span style="color:#75715e"></span><span style="color:#75715e">#define F_CPU 16000000UL 
</span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;util/delay.h&gt; //Nos permite usar delay_ms()</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span><span style="color:#75715e">&#34;display7.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
{
	display7_init();
	<span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
		display7_showNumber(<span style="color:#ae81ff">0</span>);
		_delay_ms(<span style="color:#ae81ff">1000</span>);
		display7_showNumber(<span style="color:#ae81ff">1</span>);
		_delay_ms(<span style="color:#ae81ff">1000</span>);
	}
}
</code></pre></div><p>Las definiciones están en el fichero .c, debemos agregar la interfaz a este
fichero también con la directiva #include</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">//display7.c
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span><span style="color:#75715e">&#34;display7.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_init</span>(<span style="color:#66d9ef">void</span>)
{
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> number)
{
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>)
{
}
</code></pre></div><p>En un entorno de desarrollo decente el fichero .c nos hubiera dado problemas
pues no esta permitido compilar una implementación sin indicar a que interfaz
pertenece, sin embargo el entorno de Arduino nos auto corrige el error, esto es
otra cosa por lo que no me gusta Arduino, me oculta mis errores. Nuestro código
ahora luce más modular en un diagrama luce así</p>
<p><img src="/img/7segmod.png" alt="Diseño en modulo" /></p>
<p>Como se ve en la imagen ahora proyecto.ino (función main) depende de la interfaz,
mientras que display7.c la implementa, dicho de otra forma, proyecto.ino no sabe
que hay en display7.c, el solo conoce lo que hay en display7.h, de esta manera
podemos reutilizar el módulo en otros módulos, sin miedo a romper el código
fuera de éste y muy importante sin tener que reescribir código extra.</p>
<p>Establecido lo anterior, ahora si nos toca implementar el módulo.</p>
<h2 id="implementando-la-biblioteca">
  Implementando la biblioteca
  <a class="anchor" href="#implementando-la-biblioteca">#</a>
</h2>
<p>Nuestro trabajo consiste en implementar las funciones del módulo contamos con un
par de funciones, una para iniciar y otra para cerrar el módulo y una tercera
para mostrar el número, la interfaz es muy sencilla y para nuestro propósito es
más que suficiente. Algo que olvide mencionar y que es importante, la interfaz
del módulo evoluciona, pues el desarrollo mismo provee realimentación importante.</p>
<p>Es muy común que los módulos contengan dos funciones, init y close o create y
destroy, el trabajo de estas dos funciones es llevar al módulo a un estado
conocido y liberar los recursos respectivamente. Para el módulo display7 ambas
funciones son simples.</p>
<p>En la función destroy, los recursos que se pueden liberar
son los puertos y los pines, sin embargo en este caso es de poca utilidad, pues
aunque liberemos los recursos nadie puede usarlos, esto no quiere decir que la
función destroy siempre sera tan simple, en módulos más complejos tiene una
importancia fundamental sobre todo la utilizar memoria dinámica.</p>
<p>La función init tiene la misión de establecer las condiciones adecuadas para que
el resto del módulo pueda hacer su trabajo, modificara los registros de los
puertos para establecerlos como salidas y con nivel bajo. Por ahora sabemos la
correspondencia de los pines, pero ¿qué pasa si los encargados del hardware
deciden cambiar alguno o todos los pines?, más adelante veremos este escenario.</p>
<p>Iniciemos tratando de configurar los primeros pines, corresponde PD2 y PD3, como
salida y en bajo nivel</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">//display7.c
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;display7.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;avr/io.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_init</span>(<span style="color:#66d9ef">void</span>)
{
	<span style="color:#66d9ef">short</span> pin <span style="color:#f92672">=</span> PD2;
	DDRD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
	PORTD <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);

	pin <span style="color:#f92672">=</span> PD3;
	DDRD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
	PORTD <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>)
{
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> number)
{
}
</code></pre></div><p>Excelente funciona para los dos, pero las dos asignaciones son prácticamente
idénticas, en la programación la duplicación de ideas debe evitarse pues es
una fuente de errores. Se propone crear una función que nos ayude a evitar
la repetición.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">//display7.c
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;display7.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;avr/io.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setPinOutputAndLow</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> pin);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_init</span>(<span style="color:#66d9ef">void</span>)
{

	setPinOutputAndLow(PD2);
	setPinOutputAndLow(PD3);
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setPinOutputAndLow</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> pin)
{
	DDRD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
	PORTD <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>)
{
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> number)
{
}
</code></pre></div><p>Mucho mejor, ¿pero que pasa con el pin que pertenece al puerto B?, lo primero
que requerimos es pasar el puerto como argumento de la función
<code>setPinOutputAndLow</code>, pues los nemotécnicos <code>Pxn</code> no son más que enteros entre
0 y 7, lo segundo es establecer una relación entre los pines y los puertos,
podemos hacer un arreglo bidimensional del tamaño de los pines y en cada entrada
asignar pin y puerto, los nemotécnicos de los registros son realmente apuntadores,
optamos por utilizar una variable enum para referirnos a los puertos.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">//display7.c
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;display7.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;avr/io.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">enum</span>{PORT_B, PORT_C, PORT_D}PORT;

<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> pines_table[<span style="color:#ae81ff">28</span>][<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> {
	{PC6, PORT_C}, <span style="color:#75715e">/* pin 1*/</span>
	{PD0, PORT_D},
	{PD1, PORT_D},
	{PD2, PORT_D},
	{PD3, PORT_D},
	{PD4, PORT_D},
	{<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>},
	{<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>},
	{PB6, PORT_B},
	{PB7, PORT_B},
	{PD5, PORT_D},
	{PD6, PORT_D},
	{PD7, PORT_D},
	{PB0, PORT_B}, 
	{PB1, PORT_B}, 
	{PB2, PORT_B},
	{PB3, PORT_B},
	{PB4, PORT_B},
	{PB5, PORT_B},
	{<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>},
	{<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>},
	{<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>},
	{PC0, PORT_C},
	{PC1, PORT_C},
	{PC2, PORT_C},
	{PC3, PORT_C},
	{PC4, PORT_C},
	{PC5, PORT_C}, <span style="color:#75715e">/*pin 28*/</span>
};

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setPinOutputAndLow</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> pin, PORT);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_init</span>(<span style="color:#66d9ef">void</span>)
{
	<span style="color:#66d9ef">short</span> pin <span style="color:#f92672">=</span> pines_table[<span style="color:#ae81ff">3</span>][<span style="color:#ae81ff">0</span>];
	PORT port <span style="color:#f92672">=</span> pines_table[<span style="color:#ae81ff">3</span>][<span style="color:#ae81ff">1</span>];
	setPinOutputAndLow(pin, port);
	pin <span style="color:#f92672">=</span> pines_table[<span style="color:#ae81ff">4</span>][<span style="color:#ae81ff">0</span>];
	port <span style="color:#f92672">=</span> pines_table[<span style="color:#ae81ff">4</span>][<span style="color:#ae81ff">1</span>];
	setPinOutputAndLow(pin, port);
	pin <span style="color:#f92672">=</span> pines_table[<span style="color:#ae81ff">13</span>][<span style="color:#ae81ff">0</span>];
	port <span style="color:#f92672">=</span> pines_table[<span style="color:#ae81ff">13</span>][<span style="color:#ae81ff">1</span>];
	setPinOutputAndLow(pin, port);
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setPinOutputAndLow</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> pin, PORT port)
{
	<span style="color:#66d9ef">if</span>(port <span style="color:#f92672">==</span> PORT_D){
		DDRD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
		PORTD <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
	}<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(port <span style="color:#f92672">==</span> PORT_B){
		DDRB <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
		PORTB <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
	}
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>)
{
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> number)
{
}
</code></pre></div><p>Resuelto, pero tenemos duplicación nuevamente, la sugerencia es la misma,
diseñar un función para evitarla. Para optimizar ahorrar un poco de
memoria vale la pena cambiar el tipo de variable short a char o int8,
pues cada short ocupa dos bytes.</p>
<p>La función debe indicar el puerto y pin al que el argumento pertenece.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">//display7.c
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;display7.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;avr/io.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdint.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">enum</span>{PORT_B, PORT_C, PORT_D}PORT;

uint8_t <span style="color:#66d9ef">const</span> pines_table[<span style="color:#ae81ff">28</span>][<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> {
	{PC6, PORT_C}, <span style="color:#75715e">/* pin 1*/</span>
	{PD0, PORT_D},
	{PD1, PORT_D},
	{PD2, PORT_D},
	{PD3, PORT_D},
	{PD4, PORT_D},
	{<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>},
	{<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>},
	{PB6, PORT_B},
	{PB7, PORT_B},
	{PD5, PORT_D},
	{PD6, PORT_D},
	{PD7, PORT_D},
	{PB0, PORT_B}, 
	{PB1, PORT_B},
	{PB2, PORT_B},
	{PB3, PORT_B},
	{PB4, PORT_B},
	{PB5, PORT_B},
	{<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>},
	{<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>},
	{<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>},
	{PC0, PORT_C},
	{PC1, PORT_C},
	{PC2, PORT_C},
	{PC3, PORT_C},
	{PC4, PORT_C},
	{PC5, PORT_C}, <span style="color:#75715e">/*pin 28*/</span>
};

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setPinOutputAndLow</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> pin, PORT);
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pinToRegister</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> pin);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_init</span>(<span style="color:#66d9ef">void</span>)
{
	pinToRegister(<span style="color:#ae81ff">4</span>);
	pinToRegister(<span style="color:#ae81ff">5</span>);
	pinToRegister(<span style="color:#ae81ff">14</span>);
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pinToRegister</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> pin)
{
	<span style="color:#66d9ef">short</span> pin_avr <span style="color:#f92672">=</span> pines_table[pin<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>];
	PORT port <span style="color:#f92672">=</span> pines_table[pin<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">1</span>];
	setPinOutputAndLow(pin_avr, port);
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setPinOutputAndLow</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> pin, PORT port)
{
	<span style="color:#66d9ef">if</span>(port <span style="color:#f92672">==</span> PORT_D){
		DDRD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
		PORTD <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
	}<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(port <span style="color:#f92672">==</span> PORT_B){
		DDRB <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
		PORTB <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>pin);
	}
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_destroy</span>(<span style="color:#66d9ef">void</span>)
{
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_showNumber</span>(<span style="color:#66d9ef">short</span> <span style="color:#66d9ef">const</span> number)
{
}
</code></pre></div><p>La función obtiene los pines y puertos del arreglo y los pasa a <code>setPinOutputAndLow</code>,
ahora agregamos el resto de pines del display,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">display7_init</span>(<span style="color:#66d9ef">void</span>)
{
	pinToRegister(<span style="color:#ae81ff">4</span>);
	pinToRegister(<span style="color:#ae81ff">5</span>);
	pinToRegister(<span style="color:#ae81ff">6</span>);
	pinToRegister(<span style="color:#ae81ff">11</span>);
	pinToRegister(<span style="color:#ae81ff">12</span>);
	pinToRegister(<span style="color:#ae81ff">13</span>);
	pinToRegister(<span style="color:#ae81ff">14</span>);
}
</code></pre></div><p>Funciona, hemos inicializado nuestros pines, ahora requerimos implementar la
función <code>display7_showNumber</code>, pero me gustaría pasar todo el trabajo anterior a
un nuevo módulo, requiero que <code>display7</code> se encargue solo de mostrar los
números, no de inicializarlos, la propuesta es la siguiente,</p>
<p><img src="/img/ledmodulo.png" alt="Led" /></p>
<pre><code>#define led_A (1&lt;&lt;PD2)
#define led_B (1&lt;&lt;PD3)
#define led_C (1&lt;&lt;PD4)
#define led_D (1&lt;&lt;PD5)
#define led_E (1&lt;&lt;PD6)
#define led_F (1&lt;&lt;PD7)
#define led_G (1&lt;&lt;PB0)
</code></pre><p>de esta forma el código luce más expresivo</p>
<pre><code>//display7.c
#include&quot;display7.h&quot;
#include&lt;avr/io.h&gt;

#define led\_A (1&lt;&lt;PD2)
#define led\_B (1&lt;&lt;PD3)
#define led\_C (1&lt;&lt;PD4)
#define led\_D (1&lt;&lt;PD5)
#define led\_E (1&lt;&lt;PD6)
#define led\_F (1&lt;&lt;PD7)
#define led\_G (1&lt;&lt;PB2)
void display7\_init(void)
{
	//pinout como salidas
	DDRB |= led\_G;
	DDRD |= led\_A|led\_B|led\_C|
		led\_D|led\_E|led\_F;
	//pinout nivel bajo
 	PORTB &amp;= ~led\_G;
 	PORTD &amp;= ~(led\_A|led\_B|led\_C|
		led\_D|led\_E|led\_F);
}
void display7\_destroy(void)
{
	//pinout como entradas
	DDRB &amp;= ~led\_G;
	DDRD &amp;= ~(led\_A|led\_B|led\_C|
		led\_D|led\_E|led\_F);
	//pinout nivel bajo
 	PORTB &amp;= ~led\_G;
 	PORTD &amp;= ~(led\_A|led\_B|led\_C|
		led\_D|led\_E|led\_F);
}
void display7\_showNumber(short number)
{
	if(number == 0){
		PORTB &amp;= ~led\_G; //LED G apagado
		PORTD |= led\_A|led\_B|led\_C|
			led\_D|led\_E|led\_F;
	}else if(number == 1){
		PORTB &amp;= ~led\_G;
 		PORTD &amp;= ~(led\_A|
			led\_D|led\_E|led\_F);
		PORTD |= led\_B|led\_C;//LED B y C encendido
	}
	//... hasta number == 9
}
</code></pre><p>sin embargo se ve algo críptico y no muestra por si solo las intenciones de cada función. Haremos uso de funciones auxiliares, para ayudarnos a reducir el código repetido y ser más expresivo. De inmediato identificamos que la función init esta compuesta de dos partes, establecer los pines como salidas y establecer los niveles en bajo, podemos refactorizar utilizando dos funciones auxiliares de la forma</p>
<pre><code>void display7_init(void)
{
	pinoutAsOutputs();
	pinoutLowLevel();
}
</code></pre><p>de esta forma es sencillo ver la intensión de la función init, para hacer valido el código colocamos ambas implementaciones antes de la función init</p>
<pre><code>static void pinoutAsOutputs(void)
{
	//pinout como salidas
	DDRB |= led_G;
	DDRD |=  led_A|led_B|led_C|
		led_D|led_E|led_F;
}
static void pinoutLowLevel(void)
{
	//pinout nivel bajo
 	PORTB &amp;= ~led_G;
 	PORTD &amp;= ~(led_A|led_B|led_C|
		led_D|led_E|led_F);
}
void display7_init(void)
{
	pinoutAsOutputs();
	pinoutLowLevel();
}
</code></pre><p>La palabra static(cuidado static tiene otros usos en otros contextos) sirve para indicar que las funciones únicamente pueden ser llamadas desde el mismo archivo, en este caso display7.c, en el futuro haré una entrada especifica sobre el alcance(scope).</p>
<p>Logramos un poco de legibilidad, pero también importante es que evitamos la repetición de código, ¿en donde?, hay que mirar la función destroy, que puede ser refactorizada como</p>
<pre><code>void display7_destroy(void)
{
	pinoutAsInputs();
	pinoutLowLevel();
}
</code></pre><p>pinoutLowLevel ya la implementamos, solo queda implementar pinoutAsInputs,</p>
<pre><code>static void pinoutAsOutputs(void)
{
	//pinout como salidas
	DDRB |= led_G;
	DDRD |=  led_A|led_B|led_C|
		led_D|led_E|led_F;
}
static pinoutAsInputs(void)
{
	//pinout como entradas
	DDRB &amp;= ~led_G;
	DDRD &amp;= ~(led_A|led_B|led_C|
		led_D|led_E|led_F);
}
static void pinoutLowLevel(void)
{
	//pinout nivel bajo
 	PORTB &amp;= ~led_G;
 	PORTD &amp;= ~(led_A|led_B|led_C|
		led_D|led_E|led_F);
}
void display7_init(void)
{
	pinoutAsOutputs();
	pinoutLowLevel();
}
void display7_destroy(void)
{
	pinoutAsInputs();
	pinoutLowLevel();
}
</code></pre><p>aun le falta al código, pero ya comienza a verse la forma. Más refactorización en la siguiente entrada.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#conexión-arduino-display">Conexión Arduino-Display</a></li>
    <li><a href="#biblioteca">Biblioteca</a></li>
    <li><a href="#crear-la-biblioteca">Crear la biblioteca</a></li>
    <li><a href="#implementando-la-biblioteca">Implementando la biblioteca</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>

</html>












